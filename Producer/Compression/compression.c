
/*****************************************************************************/
/* INCLUDES                                                                  */
/*****************************************************************************/

#include "compression.h"

/*****************************************************************************/
/* DEFINES                                                                   */
/*****************************************************************************/

/*****************************************************************************/
/* PRIVATE ENUMERATIONS                                                      */
/*****************************************************************************/

/*****************************************************************************/
/* PRIVATE STRUCTS                                                           */
/*****************************************************************************/

/*****************************************************************************/
/* PRIVATE FUNCTION DECLARATION                                              */
/*****************************************************************************/

/*****************************************************************************/
/* PRIVATE VARIABLES                                                         */
/*****************************************************************************/

/*****************************************************************************/
/* PRIVATE FUNCTIONS                                                         */
/*****************************************************************************/

/*****************************************************************************/
/* PUBLIC FUNCTIONS                                                          */
/*****************************************************************************/

uint32_t compression_runlength(uint8_t *buffer, const uint32_t count)
{
    uint8_t i;
    uint32_t parse_index;
    uint32_t write_index = 0;
    uint8_t length = 1;
    uint8_t last_value = buffer[0];

    for (parse_index = 1; parse_index <= count; parse_index++) {
        if (last_value == buffer[parse_index] && length < 254 && parse_index < count) {
            length = length + 1;
            continue;
        }

        if (length > 3) {
            buffer[write_index] = 0xff;
            write_index = write_index + 1;
            buffer[write_index] = last_value;
            write_index = write_index + 1;
            buffer[write_index] = length;
            write_index = write_index + 1;
        }
        else {
            for (i = 0; i < length; i++) {
                buffer[write_index] = last_value;
                write_index = write_index + 1;
            }
        }

        length = 1;
        last_value = buffer[parse_index];
    }

    return write_index;
}